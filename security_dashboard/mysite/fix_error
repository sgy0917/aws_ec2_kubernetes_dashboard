#!/bin/bash
cd /var/www/security_dashboard/mysite
source /var/www/security_dashboard/venv/bin/activate

echo "=========================================="
echo "JSON λ°μ΄ν„° μ„ν¬νΈ μ‹μ‘"
echo "=========================================="

# 1. JSON νμΌ λ©λ΅ ν™•μΈ
echo ""
echo "λ°κ²¬λ JSON νμΌ:"
ls -1 *.json 2>/dev/null || echo "JSON νμΌμ΄ μ—†μµλ‹λ‹¤!"

# 2. μ„ν¬νΈ μ‹¤ν–‰
echo ""
echo "=========================================="
echo "λ°μ΄ν„° μ„ν¬νΈ μ¤‘..."
echo "=========================================="
python manage.py import_security_data . --clear

# 3. κ²°κ³Ό ν™•μΈ
echo ""
echo "=========================================="
echo "μ„ν¬νΈ κ²°κ³Ό ν™•μΈ"
echo "=========================================="
python manage.py shell << 'PYEOF'
from dashboard.models import Asset, SecurityCheck

asset_count = Asset.objects.count()
check_count = SecurityCheck.objects.count()

print(f"\nβ… μ΄ μμ‚°: {asset_count}κ°")
print(f"β… μ΄ μ κ²€: {check_count}κ°\n")

if asset_count > 0:
    print("μμ‚° λ©λ΅:")
    for asset in Asset.objects.all()[:5]:
        print(f"  - {asset.name} ({asset.asset_code}) - {asset.latest_security_status}")
    
    if asset_count > 5:
        print(f"  ... μ™Έ {asset_count - 5}κ°")

exit()
PYEOF

# 4. Static νμΌ μμ§‘
echo ""
echo "=========================================="
echo "Static νμΌ μμ§‘ μ¤‘..."
echo "=========================================="
python manage.py collectstatic --noinput

# 5. Gunicorn μ¬μ‹μ‘
echo ""
echo "=========================================="
echo "Gunicorn μ¬μ‹μ‘ μ¤‘..."
echo "=========================================="
sudo systemctl restart gunicorn
sleep 2
sudo systemctl status gunicorn --no-pager

echo ""
echo "=========================================="
echo "π‰ μ™„λ£!"
echo "=========================================="
echo ""
echo "λΈλΌμ°μ €μ—μ„ ν™•μΈν•μ„Έμ”:"
echo "http://$(curl -s ifconfig.me)/"
echo ""
