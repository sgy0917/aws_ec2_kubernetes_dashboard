#!/bin/bash

echo "🔧 Django 마이그레이션 문제 해결 스크립트"
echo "=========================================="

# Step 1: 기존 마이그레이션 파일 백업
echo "📦 Step 1: 마이그레이션 파일 백업 중..."
if [ -d "dashboard/migrations" ]; then
    cp -r dashboard/migrations dashboard/migrations_backup_$(date +%Y%m%d_%H%M%S)
    echo "✅ 백업 완료"
fi

# Step 2: 기존 마이그레이션 파일 삭제
echo "🗑️  Step 2: 기존 마이그레이션 파일 삭제 중..."
rm -rf dashboard/migrations/0*.py
rm -rf dashboard/migrations/__pycache__
echo "✅ 삭제 완료"

# Step 3: __init__.py 확인
echo "📝 Step 3: __init__.py 확인 중..."
if [ ! -f "dashboard/migrations/__init__.py" ]; then
    touch dashboard/migrations/__init__.py
    echo "✅ __init__.py 생성 완료"
else
    echo "✅ __init__.py 존재함"
fi

# Step 4: 마이그레이션 생성
echo "🔨 Step 4: 새로운 마이그레이션 생성 중..."
python manage.py makemigrations dashboard
if [ $? -eq 0 ]; then
    echo "✅ 마이그레이션 생성 완료"
else
    echo "❌ 마이그레이션 생성 실패"
    exit 1
fi

# Step 5: 마이그레이션 적용 (fake-initial 옵션)
echo "⚙️  Step 5: 마이그레이션 적용 중..."
python manage.py migrate dashboard --fake-initial
if [ $? -eq 0 ]; then
    echo "✅ 마이그레이션 적용 완료"
else
    echo "⚠️  fake-initial 실패, 일반 migrate 시도 중..."
    python manage.py migrate dashboard
fi

# Step 6: 마이그레이션 상태 확인
echo "📊 Step 6: 마이그레이션 상태 확인 중..."
python manage.py showmigrations dashboard

echo ""
echo "✅ 마이그레이션 문제 해결 완료!"
echo "=========================================="
echo "다음 명령어로 서버를 시작하세요:"
echo "python manage.py runserver"
