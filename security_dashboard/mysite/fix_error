#!/bin/bash

echo "ğŸ”§ Django ë§ˆì´ê·¸ë ˆì´ì…˜ ë¬¸ì œ í•´ê²° ìŠ¤í¬ë¦½íŠ¸"
echo "=========================================="

# Step 1: ê¸°ì¡´ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ë°±ì—…
echo "ğŸ“¦ Step 1: ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ë°±ì—… ì¤‘..."
if [ -d "dashboard/migrations" ]; then
    cp -r dashboard/migrations dashboard/migrations_backup_$(date +%Y%m%d_%H%M%S)
    echo "âœ… ë°±ì—… ì™„ë£Œ"
fi

# Step 2: ê¸°ì¡´ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ì‚­ì œ
echo "ğŸ—‘ï¸  Step 2: ê¸°ì¡´ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ì‚­ì œ ì¤‘..."
rm -rf dashboard/migrations/0*.py
rm -rf dashboard/migrations/__pycache__
echo "âœ… ì‚­ì œ ì™„ë£Œ"

# Step 3: __init__.py í™•ì¸
echo "ğŸ“ Step 3: __init__.py í™•ì¸ ì¤‘..."
if [ ! -f "dashboard/migrations/__init__.py" ]; then
    touch dashboard/migrations/__init__.py
    echo "âœ… __init__.py ìƒì„± ì™„ë£Œ"
else
    echo "âœ… __init__.py ì¡´ì¬í•¨"
fi

# Step 4: ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„±
echo "ğŸ”¨ Step 4: ìƒˆë¡œìš´ ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„± ì¤‘..."
python manage.py makemigrations dashboard
if [ $? -eq 0 ]; then
    echo "âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„± ì™„ë£Œ"
else
    echo "âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„± ì‹¤íŒ¨"
    exit 1
fi

# Step 5: ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© (fake-initial ì˜µì…˜)
echo "âš™ï¸  Step 5: ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© ì¤‘..."
python manage.py migrate dashboard --fake-initial
if [ $? -eq 0 ]; then
    echo "âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© ì™„ë£Œ"
else
    echo "âš ï¸  fake-initial ì‹¤íŒ¨, ì¼ë°˜ migrate ì‹œë„ ì¤‘..."
    python manage.py migrate dashboard
fi

# Step 6: ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ í™•ì¸
echo "ğŸ“Š Step 6: ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ í™•ì¸ ì¤‘..."
python manage.py showmigrations dashboard

echo ""
echo "âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ë¬¸ì œ í•´ê²° ì™„ë£Œ!"
echo "=========================================="
echo "ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ì„œë²„ë¥¼ ì‹œì‘í•˜ì„¸ìš”:"
echo "python manage.py runserver"
